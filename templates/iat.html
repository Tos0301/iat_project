<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>IAT実験（完全版）</title>
  <style>
    body { text-align: center; background-color: white; font-family: sans-serif; }
    #instruction { margin-top: 100px; font-size: 24px; }
    #stimulus { margin-top: 150px; font-size: 48px; display: none; height: 200px; }
    #feedback { color: red; font-size: 36px; margin-top: 20px; }
    .categories {
      position: absolute;
      top: 20px;
      font-size: 20px;
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 0 50px;
    }
    svg { width: 120px; height: 120px; }
  </style>
</head>
<body>

<div id="instruction">
  <p>スペースキーを押すと課題が始まります。</p>
  <p>図形や単語をD（左手）またはK（右手）で分類してください。</p>
</div>

<div class="categories">
  <div id="left-label"></div>
  <div id="right-label"></div>
</div>

<div id="stimulus"></div>
<div id="feedback"></div>

<script>
const participantId = prompt("参加者IDを入力してください");
const counterbalance = parseInt(participantId) % 2 === 0; // true: ブロック3先, false: ブロック5先

function createOval() {
  return `<svg><ellipse cx="60" cy="60" rx="40" ry="60" fill="black"/></svg>`;
}
function createSquare() {
  return `<svg><rect x="10" y="10" width="100" height="100" fill="black"/></svg>`;
}

const baseStimuli = {
  oval: { type: "shape", stimulus: createOval(), label: "楕円" },
  square: { type: "shape", stimulus: createSquare(), label: "四角" },
  pleasant: ["すき", "うつくしい", "うれしい"].map(word => ({ type: "word", stimulus: word, label: "快い" })),
  unpleasant: ["きらい", "みにくい", "やかましい"].map(word => ({ type: "word", stimulus: word, label: "不快" }))
};

function generateBlock(blockNum, leftLabel, rightLabel, leftTypes, rightTypes, nTrials) {
  const stimuli = [];
  const all = leftTypes.concat(rightTypes);
  for (let i = 0; i < nTrials; i++) {
    const stimType = all[Math.floor(Math.random() * all.length)];
    const stim = { ...stimType };
    stim.block = blockNum;
    stim.left = leftLabel;
    stim.right = rightLabel;
    stim.correct = leftTypes.includes(stimType) ? "d" : "k";
    stimuli.push(stim);
  }
  return stimuli;
}

let trials = [];

// ブロック1：楕円vs四角
trials = trials.concat(generateBlock(1, "楕円", "四角", [baseStimuli.oval], [baseStimuli.square], 20));
// ブロック2：快いvs不快
trials = trials.concat(generateBlock(2, "快い", "不快", baseStimuli.pleasant, baseStimuli.unpleasant, 20));

if (counterbalance) {
  // ブロック3→4→5 の順
  trials = trials.concat(generateBlock(3, "楕円・快い", "四角・不快", [baseStimuli.oval, ...baseStimuli.pleasant], [baseStimuli.square, ...baseStimuli.unpleasant], 40));
  trials = trials.concat(generateBlock(4, "不快", "快い", baseStimuli.unpleasant, baseStimuli.pleasant, 20));
  trials = trials.concat(generateBlock(5, "楕円・不快", "四角・快い", [baseStimuli.oval, ...baseStimuli.unpleasant], [baseStimuli.square, ...baseStimuli.pleasant], 40));
} else {
  // ブロック5→4→3 の順
  trials = trials.concat(generateBlock(5, "楕円・不快", "四角・快い", [baseStimuli.oval, ...baseStimuli.unpleasant], [baseStimuli.square, ...baseStimuli.pleasant], 40));
  trials = trials.concat(generateBlock(4, "不快", "快い", baseStimuli.unpleasant, baseStimuli.pleasant, 20));
  trials = trials.concat(generateBlock(3, "楕円・快い", "四角・不快", [baseStimuli.oval, ...baseStimuli.pleasant], [baseStimuli.square, ...baseStimuli.unpleasant], 40));
}

let trialIndex = -1;
let startTime = 0;

document.addEventListener("keydown", async (e) => {
  if (e.code === "Space" && trialIndex === -1) {
    document.getElementById("instruction").style.display = "none";
    nextTrial();
  }

  if (["KeyD", "KeyK"].includes(e.code) && trialIndex >= 0) {
    const trial = trials[trialIndex];
    const response = e.code === "KeyD" ? "d" : "k";
    const correct = response === trial.correct;
    const rt = performance.now() - startTime;

    document.getElementById("feedback").innerText = correct ? "" : "×";

    await fetch("/log", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        participant_id: participantId,
        block: trial.block,
        stimulus: trial.stimulus.replace(/<[^>]+>/g, ''), // SVG除去
        response: response,
        correct: correct,
        reaction_time: Math.round(rt)
      })
    });

    setTimeout(() => {
      document.getElementById("feedback").innerText = "";
      nextTrial();
    }, 400);
  }
});

function nextTrial() {
  trialIndex++;
  if (trialIndex >= trials.length) {
    document.getElementById("stimulus").innerText = "終了しました。ありがとうございました。";
    return;
  }

  const trial = trials[trialIndex];
  document.getElementById("left-label").innerText = trial.left;
  document.getElementById("right-label").innerText = trial.right;

  const stimDiv = document.getElementById("stimulus");
  stimDiv.style.display = "block";
  stimDiv.innerHTML = trial.stimulus;

  startTime = performance.now();
}
</script>
</body>
</html>
